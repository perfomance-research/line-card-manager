<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„éŒ¢åŒ…</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* å…±ç”¨è®Šæ•¸ */
        :root { --primary: #FF9F43; --bg: #FFF5E1; --text: #5E4B35; --bar-bg: #E0E0E0; --danger: #FF6B6B; }
        body { font-family: "Varela Round", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; margin:0; }

        /* å¯æ„›å¡ç‰‡æ¨£å¼ */
        .credit-card {
            background: #fff;
            border-radius: 20px;
            padding: 15px;
            margin: 15px 20px;
            box-shadow: 0 8px 20px rgba(94, 75, 53, 0.1);
            position: relative;
            overflow: hidden;
            border: 2px solid #FFF0D4;
        }

        .card-visual {
            height: 160px;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            background-color: #333; /* é è¨­æ·±è‰² */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 15px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 15px;
            position: relative;
        }
        
        /* é¡åº¦é€²åº¦æ¢ */
        .limit-info { margin-top: 10px; }
        .progress-bar {
            height: 10px; background: var(--bar-bg); border-radius: 5px; overflow: hidden; margin: 5px 0;
        }
        .progress-fill {
            height: 100%; background: var(--primary); width: 0%; transition: width 0.5s;
        }
        .limit-text { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; }
        .payment-date { font-size: 0.8rem; color: var(--danger); font-weight: bold; margin-top: 5px; text-align: right; }

        /* ä¸Šå‚³åœ–ç‰‡é è¦½ */
        .upload-box {
            border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; margin-bottom: 15px;
        }
        .preview-img { width: 100%; height: 160px; object-fit: cover; border-radius: 10px; display: none; }

        /* åº•éƒ¨å°èˆª (å¯æ„›é¢¨) */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: #fff; border-radius: 50px;
            display: flex; justify-content: space-around; padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .nav-item { text-align: center; color: #ccc; flex: 1; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .nav-text { font-size: 0.7rem; display: block; margin-top: 2px; }

        /* è¡¨å–®æ¨£å¼ */
        input, select { width: 100%; padding: 12px; border: 2px solid #EEE; border-radius: 12px; margin-bottom: 15px; box-sizing: border-box; }
        .btn-primary { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 0 #E67E22; }
        .btn-primary:active { transform: translateY(4px); box-shadow: none; }
        
        .container { display: none; padding-top: 20px; }
        .container.active { display: block; }
    </style>
</head>
<body>

    <div id="viewWallet" class="container active">
        <h2 style="text-align:center; color:var(--text);">æˆ‘çš„å¯æ„›éŒ¢åŒ… ğŸ‘›</h2>
        <div id="cardList">
            <div style="text-align:center; padding:50px; color:#aaa;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div id="viewAdd" class="container" style="padding: 20px;">
        <h2 style="text-align:center;">æ–°å¢å¡ç‰‡ âœ¨</h2>
        <form id="addForm">
            <label>å¡ç‰‡æš±ç¨±</label>
            <input type="text" id="cardName" placeholder="ä¾‹å¦‚ï¼šåƒé£¯å°ˆç”¨å¡">
            
            <label>ç™¼å¡éŠ€è¡Œ</label>
            <select id="bankSelect">
                <option value="taishin">å°æ–°éŠ€è¡Œ</option>
                <option value="fubon">å¯Œé‚¦éŠ€è¡Œ</option>
                <option value="cathay">åœ‹æ³°ä¸–è¯</option>
                <option value="ctbc">ä¸­åœ‹ä¿¡è¨—</option>
                <option value="other">å…¶ä»–éŠ€è¡Œ</option>
            </select>

            <label>è‡ªè¨‚å¡é¢ (é»æ“Šä¸Šå‚³)</label>
            <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="previewFile()">
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-camera fa-2x"></i><br>ä¸Šå‚³åœ–ç‰‡
            </div>
            <img id="previewImg" class="preview-img">
            <input type="hidden" id="imageBase64">

            <label>ä¿¡ç”¨é¡åº¦</label>
            <input type="number" id="limit" placeholder="200000">

            <label>çµå¸³æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label>
            <input type="number" id="statementDay" placeholder="5">

            <label>ç¹³æ¬¾æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label>
            <input type="number" id="paymentDay" placeholder="20">

            <button type="button" class="btn-primary" onclick="submitCard()">ç¢ºèªæ–°å¢</button>
        </form>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('viewWallet')">
            <i class="fas fa-wallet"></i><span class="nav-text">éŒ¢åŒ…</span>
        </div>
        <div class="nav-item" onclick="switchTab('viewAdd')">
            <i class="fas fa-plus-circle"></i><span class="nav-text">æ–°å¢</span>
        </div>
        <div class="nav-item" onclick="location.href='accounting.html'">
            <i class="fas fa-calculator"></i><span class="nav-text">è¨˜å¸³</span>
        </div>
    </nav>

    <script>
        const GAS_URL = 'æ‚¨çš„_GAS_æ–°ç¶²å€'; // âš ï¸ è«‹æ›æˆæ–°ç¶²å€
        const LIFF_ID = 'æ‚¨çš„_LIFF_ID'; 
        let currentUserId = null;

        window.onload = async () => {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) liff.login();
            else {
                currentUserId = (await liff.getProfile()).userId;
                loadWallet();
            }
        };

        function loadWallet() {
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'get_wallet', userId: currentUserId }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            })
            .then(res => res.json())
            .then(res => renderCards(res.data));
        }

        function renderCards(cards) {
            const list = document.getElementById('cardList');
            if(!cards || cards.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:50px;">é‚„æ²’æœ‰å¡ç‰‡å–”<br>å¿«å»æ–°å¢ä¸€å¼µå§ï¼</div>';
                return;
            }
            let html = '';
            cards.forEach(c => {
                // è¨ˆç®—é€²åº¦æ¢
                const used = c.used || 0;
                const limit = c.limit || 1;
                const percent = Math.min((used / limit) * 100, 100);
                const bgImage = c.custom_image ? `url(${c.custom_image})` : 'linear-gradient(45deg, #FF9F43, #FF6B6B)';

                html += `
                <div class="credit-card">
                    <div class="card-visual" style="background-image: ${bgImage}">
                        <div style="font-size:1.2rem; font-weight:bold;">${c.card_name}</div>
                        <div style="font-size:0.8rem; opacity:0.9;">${getBankName(c.bank)}</div>
                    </div>
                    <div class="limit-info">
                        <div class="limit-text">
                            <span>å·²ç”¨ $${used.toLocaleString()}</span>
                            <span>é¡åº¦ $${limit.toLocaleString()}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%;"></div>
                        </div>
                        <div class="payment-date">
                            <i class="far fa-clock"></i> ä¸‹æ¬¡ç¹³æ¬¾ï¼šæ¯æœˆ ${c.payment_day} è™Ÿ
                        </div>
                    </div>
                </div>`;
            });
            list.innerHTML = html;
        }

        // åœ–ç‰‡è½‰ Base64
        function previewFile() {
            const file = document.getElementById('fileInput').files[0];
            const reader = new FileReader();
            reader.onloadend = function() {
                document.getElementById('previewImg').src = reader.result;
                document.getElementById('previewImg').style.display = "block";
                document.getElementById('imageBase64').value = reader.result; // å­˜å…¥éš±è—æ¬„ä½
            }
            if (file) reader.readAsDataURL(file);
        }

        function submitCard() {
            const btn = document.querySelector('.btn-primary');
            btn.innerText = "ä¸Šå‚³ä¸­..."; btn.disabled = true;

            const data = {
                action: 'save_card',
                userId: currentUserId,
                bank: document.getElementById('bankSelect').value,
                cardName: document.getElementById('cardName').value,
                image: document.getElementById('imageBase64').value, // åœ–ç‰‡è³‡æ–™
                limit: document.getElementById('limit').value,
                statementDay: document.getElementById('statementDay').value,
                paymentDay: document.getElementById('paymentDay').value
            };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            })
            .then(res => res.json())
            .then(res => {
                alert('æ–°å¢æˆåŠŸï¼');
                location.reload();
            });
        }

        function switchTab(id) {
            document.querySelectorAll('.container').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function getBankName(code) { return { 'taishin': 'å°æ–°éŠ€è¡Œ', 'fubon': 'å¯Œé‚¦éŠ€è¡Œ' }[code] || 'éŠ€è¡Œ'; }
    </script>
</body>
</html>
