<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¿¡ç”¨å¡ç®¡ç†</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        select, input, button { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;}
        button { background-color: #06c755; color: white; border: none; font-weight: bold; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ’³ æ–°å¢ä¿¡ç”¨å¡</h2>
        <div id="loading">è¼‰å…¥ä¸­...</div>
        
        <form id="cardForm" class="hidden">
            <label>1. é¸æ“‡éŠ€è¡Œ</label>
            <select id="bankSelect" onchange="loadCards()">
                <option value="">è«‹é¸æ“‡éŠ€è¡Œ</option>
                <option value="taishin">å°æ–°éŠ€è¡Œ</option>
                <option value="fubon">å¯Œé‚¦éŠ€è¡Œ</option>
            </select>

            <label>2. é¸æ“‡å¡ç‰‡</label>
            <select id="cardSelect" disabled>
                <option value="">è«‹å…ˆé¸æ“‡éŠ€è¡Œ</option>
            </select>

            <label>3. ä¿¡ç”¨é¡åº¦</label>
            <input type="number" id="limit" placeholder="ä¾‹å¦‚ï¼š200000">

            <label>4. çµå¸³æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label>
            <select id="statementDay">
                </select>

            <label>5. ç¹³æ¬¾æˆªæ­¢æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label>
            <select id="paymentDay">
                </select>

            <button type="button" onclick="submitData()">å„²å­˜å¡ç‰‡</button>
        </form>
    </div>

    <script>
        // è¨­å®šå€ï¼šé€™è£¡è¦æ›æˆä½ çš„
        const LIFF_ID = '2009160981-CWCxMTaI'; 
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbweZezY0wo4062OTpi3CZjgYrvACCMBSiXxyIqNTyHtXz1HCFC2soOzJr9_T23hBYGBfA/exec'; 

        // å‡è³‡æ–™ï¼šéŠ€è¡Œèˆ‡å¡ç‰‡å°æ‡‰ (æœªä¾†å¯ä»¥å¾ GAS è®€å–)
        const cardDatabase = {
            "taishin": [
                {code: "c_001", name: "å°æ–° @GoGo å¡"},
                {code: "c_002", name: "å°æ–° FlyGo å¡"}
            ],
            "fubon": [
                {code: "c_003", name: "å¯Œé‚¦ J å¡"},
                {code: "c_004", name: "å¯Œé‚¦ momo å¡"}
            ]
        };

        // åˆå§‹åŒ–
        window.onload = function() {
            initializeLiff();
            populateDays();
        };

        function initializeLiff() {
            liff.init({ liffId: LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('cardForm').classList.remove('hidden');
                }
            }).catch(err => {
                console.error(err);
                alert("LIFF åˆå§‹åŒ–å¤±æ•—");
            });
        }

        function loadCards() {
            const bank = document.getElementById('bankSelect').value;
            const cardSelect = document.getElementById('cardSelect');
            cardSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¡ç‰‡</option>';
            
            if (bank && cardDatabase[bank]) {
                cardSelect.disabled = false;
                cardDatabase[bank].forEach(card => {
                    cardSelect.innerHTML += `<option value="${card.code}">${card.name}</option>`;
                });
            } else {
                cardSelect.disabled = true;
            }
        }

        function populateDays() {
            const sDay = document.getElementById('statementDay');
            const pDay = document.getElementById('paymentDay');
            for(let i=1; i<=31; i++) {
                sDay.innerHTML += `<option value="${i}">${i} è™Ÿ</option>`;
                pDay.innerHTML += `<option value="${i}">${i} è™Ÿ</option>`;
            }
        }

        function submitData() {
            // é¡¯ç¤ºè¼‰å…¥ä¸­... (å»ºè­°åœ¨ UI ä¸ŠåŠ å€‹ Loading æ•ˆæœ)
            const submitBtn = document.querySelector('button');
            submitBtn.textContent = "å„²å­˜ä¸­...";
            submitBtn.disabled = true;

            liff.getProfile().then(profile => {
                const userId = profile.userId;
                
                // æº–å‚™è¦å‚³é€çš„è³‡æ–™
                const data = {
                    action: "save_card", 
                    userId: userId,
                    bank: document.getElementById('bankSelect').value, // è¨˜å¾—è£œä¸Šé€™è¡Œ
                    cardName: document.getElementById('cardSelect').options[document.getElementById('cardSelect').selectedIndex].text, // æŠ“å–å¡ç‰‡åç¨±
                    cardCode: document.getElementById('cardSelect').value,
                    limit: document.getElementById('limit').value,
                    statementDay: document.getElementById('statementDay').value,
                    paymentDay: document.getElementById('paymentDay').value
                };

                if(!data.cardCode) { 
                    alert("è«‹é¸æ“‡å¡ç‰‡"); 
                    submitBtn.textContent = "å„²å­˜å¡ç‰‡";
                    submitBtn.disabled = false;
                    return; 
                }

                // --- é—œéµä¿®æ­£é–‹å§‹ ---
                // ä½¿ç”¨ text/plain é¿é–‹ CORS OPTION é æª¢è«‹æ±‚
                fetch(GAS_API_URL, {
                    method: "POST",
                    body: JSON.stringify(data), // å°‡ç‰©ä»¶è½‰ç‚ºå­—ä¸²
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8" 
                    }
                })
                .then(response => response.json()) // è§£æå›å‚³çš„ JSON
                .then(result => {
                    if(result.status === "success") {
                        alert("ğŸ‰ å„²å­˜æˆåŠŸï¼");
                        liff.closeWindow(); // é—œé–‰è¦–çª—
                    } else {
                        alert("å„²å­˜å¤±æ•—ï¼š" + (result.msg || "æœªçŸ¥éŒ¯èª¤"));
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                        submitBtn.textContent = "å„²å­˜å¡ç‰‡";
                        submitBtn.disabled = false;
                    }
                })
                .catch(err => {
                    console.error("Fetch Error:", err); // åœ¨ F12 console é¡¯ç¤ºè©³ç´°éŒ¯èª¤
                    alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ï¼š\n1. GAS éƒ¨ç½²æ¬Šé™æ˜¯å¦ç‚ºã€Œä»»ä½•äººã€\n2. ç¶²å€æ˜¯å¦æ­£ç¢º");
                    submitBtn.textContent = "å„²å­˜å¡ç‰‡";
                    submitBtn.disabled = false;
                });
                // --- é—œéµä¿®æ­£çµæŸ ---

            }).catch(err => {
                console.error("LIFF Error:", err);
                alert("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼Œè«‹ç¢ºèªå·²åœ¨ LINE ä¸­é–‹å•Ÿ");
            });
        }
    </script>
</body>
</html>
