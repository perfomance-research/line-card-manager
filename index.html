<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>信用卡管家</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #06c755;
            --bg: #f5f6f8;
            --card-bg: #ffffff;
            --text-main: #1f1f1f;
            --text-sub: #888888;
            --danger: #ff3b30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            padding-bottom: 80px; /* 預留底部導航空間 */
        }

        /* 頂部標題 */
        header {
            background: var(--card-bg);
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        h1 { margin: 0; font-size: 1.2rem; text-align: center; }

        /* 內容容器 */
        .container { padding: 20px; display: none; }
        .container.active { display: block; }

        /* === 1. 錢包視圖 (My Wallet) === */
        .wallet-summary {
            background: linear-gradient(135deg, #06c755, #04b34a);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3);
        }
        .total-limit-label { font-size: 0.8rem; opacity: 0.9; }
        .total-limit-value { font-size: 1.8rem; font-weight: bold; margin-top: 5px; }

        /* 卡片列表 */
        .credit-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 0; /* 圖片滿版 */
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .credit-card:active { transform: scale(0.98); }

        .card-visual {
            height: 140px;
            background: linear-gradient(135deg, #333, #555);
            padding: 20px;
            color: white;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        /* 根據銀行變色 (範例) */
        .card-visual[data-bank="taishin"] { background: linear-gradient(135deg, #e60012, #99000c); }
        .card-visual[data-bank="fubon"] { background: linear-gradient(135deg, #005598, #003366); }

        .card-name { font-size: 1.1rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .card-bank { font-size: 0.8rem; opacity: 0.8; }
        .card-info-row { display: flex; justify-content: space-between; font-size: 0.9rem; }
        
        .card-actions {
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            background: #fff;
        }
        .btn-delete {
            color: var(--danger);
            background: none;
            border: none;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* === 2. 新增表單 (Add Card) === */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select {
            width: 100%; padding: 14px; border: 1px solid #eee;
            border-radius: 12px; background: #fff; font-size: 16px; box-sizing: border-box;
        }
        .btn-primary {
            width: 100%; padding: 16px; background: var(--primary);
            color: white; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
        }

        /* === 底部導航列 === */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid #eee;
            display: flex; justify-content: space-around;
            padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item {
            flex: 1; text-align: center; color: var(--text-sub);
            font-size: 0.7rem; cursor: pointer;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 4px; }

        /* Loading & Empty State */
        .loading { text-align: center; padding: 40px; color: #999; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .empty-state i { font-size: 3rem; margin-bottom: 10px; color: #ddd; }

    </style>
</head>
<body>

    <header>
        <h1 id="pageTitle">我的錢包</h1>
    </header>

    <div id="viewWallet" class="container active">
        <div class="wallet-summary">
            <div class="total-limit-label">總信用額度</div>
            <div class="total-limit-value" id="totalLimit">NT$ 0</div>
        </div>
        
        <div id="cardList">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>
        </div>
    </div>

    <div id="viewAdd" class="container">
        <form id="addForm">
            <div class="form-group">
                <label>發卡銀行</label>
                <select id="bankSelect" onchange="updateCardOptions()">
                    <option value="">請選擇</option>
                    <option value="taishin">台新銀行</option>
                    <option value="fubon">富邦銀行</option>
                    <option value="cathay">國泰世華</option>
                </select>
            </div>
            <div class="form-group">
                <label>選擇卡片</label>
                <select id="cardSelect" disabled>
                    <option value="">請先選擇銀行</option>
                </select>
            </div>
            <div class="form-group">
                <label>信用額度</label>
                <input type="number" id="limit" placeholder="例如 200000" inputmode="numeric">
            </div>
            <div class="form-group">
                <label>結帳日 (每月)</label>
                <select id="statementDay"></select>
            </div>
            <div class="form-group">
                <label>繳款日 (每月)</label>
                <select id="paymentDay"></select>
            </div>
            <button type="button" class="btn-primary" onclick="submitCard()">確認新增</button>
        </form>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('viewWallet')">
            <i class="fas fa-wallet"></i>
            錢包
        </div>
        <div class="nav-item" onclick="switchTab('viewAdd')">
            <i class="fas fa-plus-circle"></i>
            新增
        </div>
    </nav>

    <script>
        // ================= CONFIG =================
        const LIFF_ID = '2009160981-CWCxMTaI'; 
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzqWS-QzdAOxv-gxl97LAH5A-Ua00MC-oOBWwprri6Hf2ICBNJLsDgvGEaOba_xwrMGKw/exec'; 
        // ==========================================

        // 卡片資料庫 (前端選單用，實際權益在 Firebase)
        const cardDb = {
            "taishin": [
                {code: "c_001", name: "台新 @GoGo 卡"},
                {code: "c_002", name: "台新 FlyGo 卡"},
                {code: "c_004", name: "台新 太陽/玫瑰 (天天刷)"}
            ],
            "fubon": [
                {code: "c_005", name: "富邦 J 卡"},
                {code: "c_006", name: "富邦 momo 卡"}
            ],
            "cathay": [
                {code: "c_009", name: "國泰 CUBE 卡"}
            ]
        };

        let currentUserId = null;

        // 初始化
        window.onload = async function() {
            initDateSelects();
            await initLiff();
        };

        // LIFF 初始化
        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    currentUserId = profile.userId;
                    fetchWalletData(); // 登入後立刻抓資料
                }
            } catch (err) {
                console.error(err);
                alert("LIFF 錯誤: " + err.message);
            }
        }

        // 讀取錢包資料 (GET)
        function fetchWalletData() {
            const listDiv = document.getElementById('cardList');
            listDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 資料同步中...</div>';

            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "get_wallet", userId: currentUserId }),
                headers: { "Content-Type": "text/plain;charset=utf-8" }
            })
            .then(res => res.json())
            .then(res => {
                if(res.status === "success") {
                    renderCards(res.data);
                } else {
                    listDiv.innerHTML = '<div class="empty-state">讀取失敗</div>';
                }
            });
        }

        // 渲染卡片列表
        function renderCards(cards) {
            const listDiv = document.getElementById('cardList');
            const totalDiv = document.getElementById('totalLimit');
            
            if (!cards || cards.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="far fa-credit-card"></i>
                        <p>您尚未新增任何卡片</p>
                        <button class="btn-primary" style="margin-top:10px; width:auto;" onclick="switchTab('viewAdd')">立即新增</button>
                    </div>`;
                totalDiv.innerText = "NT$ 0";
                return;
            }

            let html = '';
            let total = 0;

            cards.forEach((card, index) => {
                total += (card.limit || 0);
                html += `
                    <div class="credit-card">
                        <div class="card-visual" data-bank="${card.bank}">
                            <div class="card-bank">${getBankName(card.bank)}</div>
                            <div class="card-name">${card.card_name}</div>
                            <div class="card-info-row">
                                <span>**** **** **** ${index + 1234}</span>
                                <span>結帳日 ${card.statement_day} 號</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn-delete" onclick="deleteCard(${index})">
                                <i class="fas fa-trash-alt"></i> 移除
                            </button>
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
            totalDiv.innerText = "NT$ " + total.toLocaleString();
        }

        // 新增卡片 (POST)
        function submitCard() {
            const bank = document.getElementById('bankSelect').value;
            const code = document.getElementById('cardSelect').value;
            const limit = document.getElementById('limit').value;

            if(!bank || !code || !limit) { alert("請填寫完整資訊"); return; }

            // 顯示 Loading
            const btn = document.querySelector('#addForm .btn-primary');
            const originalText = btn.innerText;
            btn.innerText = "儲存中...";
            btn.disabled = true;

            const data = {
                action: "save_card",
                userId: currentUserId,
                bank: bank,
                cardCode: code,
                cardName: document.getElementById('cardSelect').selectedOptions[0].text,
                limit: limit,
                statementDay: document.getElementById('statementDay').value,
                paymentDay: document.getElementById('paymentDay').value
            };

            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify(data),
                headers: { "Content-Type": "text/plain;charset=utf-8" }
            })
            .then(res => res.json())
            .then(res => {
                if(res.status === "success") {
                    alert("新增成功！");
                    document.getElementById('addForm').reset();
                    switchTab('viewWallet'); // 切換回列表
                    fetchWalletData(); // 重新整理
                } else {
                    alert("失敗: " + res.msg);
                }
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }

        // 刪除卡片
        function deleteCard(index) {
            if(!confirm("確定要移除這張卡片嗎？")) return;

            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "delete_card", userId: currentUserId, cardIndex: index }),
                headers: { "Content-Type": "text/plain;charset=utf-8" }
            })
            .then(res => res.json())
            .then(res => {
                if(res.status === "success") fetchWalletData();
                else alert("刪除失敗");
            });
        }

        // 頁面切換邏輯
        function switchTab(tabId) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(tabId === 'viewWallet') {
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
                document.getElementById('pageTitle').innerText = "我的錢包";
            } else {
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                document.getElementById('pageTitle').innerText = "新增卡片";
            }
        }

        // 輔助函式
        function updateCardOptions() {
            const bank = document.getElementById('bankSelect').value;
            const select = document.getElementById('cardSelect');
            select.innerHTML = '<option value="">請選擇卡片</option>';
            select.disabled = true;
            if(bank && cardDb[bank]) {
                cardDb[bank].forEach(c => {
                    select.innerHTML += `<option value="${c.code}">${c.name}</option>`;
                });
                select.disabled = false;
            }
        }

        function initDateSelects() {
            let opts = '';
            for(let i=1; i<=31; i++) opts += `<option value="${i}">${i} 號</option>`;
            document.getElementById('statementDay').innerHTML = opts;
            document.getElementById('paymentDay').innerHTML = opts;
        }
        
        function getBankName(code) {
            const map = { 'taishin': '台新銀行', 'fubon': '富邦銀行', 'cathay': '國泰世華' };
            return map[code] || code;
        }
    </script>
</body>
</html>
