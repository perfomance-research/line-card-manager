<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ–°å¢ä¿¡ç”¨å¡ | éŒ¢åŒ…ç®¡ç†</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- CSS æ¨£å¼å€ï¼šè®“ä»‹é¢åœ¨æ‰‹æ©Ÿä¸Šçœ‹èµ·ä¾†æ›´æ¼‚äº® --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        h2 {
            text-align: center;
            color: #111;
            margin-bottom: 25px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
            box-sizing: border-box;
            background-color: #fff;
            appearance: none; /* ç§»é™¤é è¨­ç®­é ­ */
        }

        /* è‡ªè¨‚ Select ç®­é ­ */
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: 'â–¼';
            font-size: 12px;
            color: #888;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #06c755; /* LINE Green */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        button:active {
            background-color: #05a546;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* è¼‰å…¥ä¸­é®ç½© */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 999;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #06c755;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        
        .note {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText">ç³»çµ±é€£ç·šä¸­...</div>
    </div>

    <div class="container hidden" id="mainForm">
        <h2>ğŸ’³ æ–°å¢ä¿¡ç”¨å¡</h2>
        
        <form>
            <div class="form-group">
                <label>1. ç™¼å¡éŠ€è¡Œ</label>
                <div class="select-wrapper">
                    <select id="bankSelect" onchange="updateCardList()">
                        <option value="">è«‹é¸æ“‡éŠ€è¡Œ</option>
                        <option value="taishin">å°æ–°éŠ€è¡Œ</option>
                        <option value="fubon">å¯Œé‚¦éŠ€è¡Œ</option>
                        <option value="ctbc">ä¸­åœ‹ä¿¡è¨—</option>
                        <option value="cathay">åœ‹æ³°ä¸–è¯</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>2. é¸æ“‡å¡ç‰‡</label>
                <div class="select-wrapper">
                    <select id="cardSelect" disabled>
                        <option value="">è«‹å…ˆé¸æ“‡éŠ€è¡Œ</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>3. ä¿¡ç”¨é¡åº¦ (TWD)</label>
                <input type="number" id="limit" placeholder="ä¾‹å¦‚ï¼š200000" inputmode="numeric">
            </div>

            <div class="form-group">
                <label>4. çµå¸³æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label>
                <div class="select-wrapper">
                    <select id="statementDay">
                        </select>
                </div>
            </div>

            <div class="form-group">
                <label>5. ç¹³æ¬¾æˆªæ­¢æ—¥ (æ¯æœˆå¹¾è™Ÿ)</label>
                <div class="select-wrapper">
                    <select id="paymentDay">
                        </select>
                </div>
            </div>

            <button type="button" id="submitBtn" onclick="submitData()">ç¢ºèªå„²å­˜</button>
            <div class="note">è³‡æ–™å°‡å®‰å…¨å„²å­˜æ–¼æ‚¨çš„å€‹äººè³‡æ–™åº«</div>
        </form>
    </div>

    <script>
        // ==========================================
        // âš ï¸ è¨­å®šå€ï¼šè«‹å‹™å¿…ä¿®æ”¹é€™è£¡ï¼ï¼ï¼
        // ==========================================
        const LIFF_ID = '2009160981-CWCxMTaI'; // ä¾‹å¦‚ '1657xxxxx-xxxxxx'
        
        // è«‹å¡«å…¥ GAS éƒ¨ç½²å¾Œå–å¾—çš„æœ€æ–°ç¶²å€ (çµå°¾é€šå¸¸æ˜¯ /exec)
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx49eoL86qqrr_DZlOYXD7STxNs4-PlGdxHg29vGqxfoC1oDKeX2Uft0Uz3omzail-8AA/exec'; 

        // ==========================================
        // å¡ç‰‡è³‡æ–™åº« (ç”¨æ–¼å‰ç«¯é¸å–®)
        // ==========================================
        const cardDatabase = {
            "taishin": [
                {code: "c_001", name: "å°æ–° @GoGo å¡"},
                {code: "c_002", name: "å°æ–° FlyGo å¡"},
                {code: "c_003", name: "å°æ–° ç«ç‘° Giving å¡"},
                {code: "c_004", name: "å°æ–° å¤ªé™½/ç«ç‘°å¡ (å¤©å¤©åˆ·)"}
            ],
            "fubon": [
                {code: "c_005", name: "å¯Œé‚¦ J å¡"},
                {code: "c_006", name: "å¯Œé‚¦ momo å¡"}
            ],
            "ctbc": [
                {code: "c_007", name: "ä¸­ä¿¡ LINE Pay å¡"},
                {code: "c_008", name: "ä¸­ä¿¡ è‹±é›„è¯ç›Ÿå¡"}
            ],
            "cathay": [
                {code: "c_009", name: "åœ‹æ³° CUBE å¡"}
            ]
        };

        // ==========================================
        // ç¨‹å¼é‚è¼¯å€
        // ==========================================
        
        // 1. åˆå§‹åŒ–
        window.onload = function() {
            populateDays(); // ç”¢ç”Ÿæ—¥æœŸé¸å–®
            initializeLiff(); // å•Ÿå‹• LIFF
        };

        // 2. ç”¢ç”Ÿ 1-31 æ—¥çš„é¸é …
        function populateDays() {
            const sDay = document.getElementById('statementDay');
            const pDay = document.getElementById('paymentDay');
            let options = "";
            for(let i=1; i<=31; i++) {
                options += `<option value="${i}">${i} è™Ÿ</option>`;
            }
            sDay.innerHTML = options;
            pDay.innerHTML = options;
            // é è¨­å€¼èª¿æ•´
            sDay.value = "5";
            pDay.value = "20";
        }

        // 3. éŠ€è¡Œèˆ‡å¡ç‰‡é€£å‹•
        function updateCardList() {
            const bank = document.getElementById('bankSelect').value;
            const cardSelect = document.getElementById('cardSelect');
            
            cardSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¡ç‰‡</option>';
            
            if (bank && cardDatabase[bank]) {
                cardSelect.disabled = false;
                cardDatabase[bank].forEach(card => {
                    const opt = document.createElement('option');
                    opt.value = card.code;
                    opt.text = card.name;
                    cardSelect.appendChild(opt);
                });
            } else {
                cardSelect.disabled = true;
            }
        }

        // 4. åˆå§‹åŒ– LIFF
        function initializeLiff() {
            liff.init({ liffId: LIFF_ID })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        // ç™»å…¥æˆåŠŸï¼Œé¡¯ç¤ºè¡¨å–®
                        document.getElementById('loadingOverlay').classList.add('hidden');
                        document.getElementById('mainForm').classList.remove('hidden');
                    }
                })
                .catch((err) => {
                    console.error('LIFF Init Failed:', err);
                    document.getElementById('loadingText').innerText = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç”¨ LINE é–‹å•Ÿ";
                    alert("LIFF éŒ¯èª¤ï¼š" + err.message);
                });
        }

        // 5. é€å‡ºè³‡æ–™ (æ ¸å¿ƒåŠŸèƒ½)
        function submitData() {
            const submitBtn = document.getElementById('submitBtn');
            const bankSelect = document.getElementById('bankSelect');
            const cardSelect = document.getElementById('cardSelect');
            const limitInput = document.getElementById('limit');

            // --- åŸºç¤é©—è­‰ ---
            if (!bankSelect.value) { alert("è«‹é¸æ“‡éŠ€è¡Œ"); return; }
            if (!cardSelect.value) { alert("è«‹é¸æ“‡å¡ç‰‡"); return; }
            if (!limitInput.value) { alert("è«‹è¼¸å…¥ä¿¡ç”¨é¡åº¦"); return; }

            // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
            submitBtn.disabled = true;
            submitBtn.innerText = "è³‡æ–™å„²å­˜ä¸­...";

            liff.getProfile().then(profile => {
                const userId = profile.userId;
                
                // æº–å‚™è³‡æ–™ç‰©ä»¶
                const postData = {
                    action: "save_card",
                    userId: userId,
                    bank: bankSelect.value,
                    cardCode: cardSelect.value,
                    cardName: cardSelect.options[cardSelect.selectedIndex].text,
                    limit: limitInput.value,
                    statementDay: document.getElementById('statementDay').value,
                    paymentDay: document.getElementById('paymentDay').value
                };

                // --- é—œéµ Fetch è«‹æ±‚ ---
                // ä½¿ç”¨ text/plain é¿é–‹ CORS é æª¢ (Preflight)
                fetch(GAS_API_URL, {
                    method: "POST",
                    body: JSON.stringify(postData),
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8"
                    }
                })
                .then(response => response.json()) // è§£æå›å‚³çš„ JSON
                .then(result => {
                    if(result.status === "success") {
                        alert("âœ… å¡ç‰‡è¨­å®šæˆåŠŸï¼\næ©Ÿå™¨äººå·²ç´€éŒ„æ‚¨çš„è³‡æ–™ã€‚");
                        liff.closeWindow(); // é—œé–‰è¦–çª—
                    } else {
                        throw new Error(result.msg || "æœªçŸ¥éŒ¯èª¤");
                    }
                })
                .catch(error => {
                    console.error("Fetch Error:", error);
                    alert("âŒ å„²å­˜å¤±æ•—ï¼š\nè«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™æ˜¯å¦ç‚ºã€Œä»»ä½•äººã€\n" + error.message);
                    submitBtn.disabled = false;
                    submitBtn.innerText = "ç¢ºèªå„²å­˜";
                });

            }).catch(err => {
                alert("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹é‡æ–°é–‹å•Ÿã€‚");
                submitBtn.disabled = false;
            });
        }
    </script>
</body>
</html>
