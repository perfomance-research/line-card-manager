<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è¨˜å¸³</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #54a0ff; --income: #1dd1a1; --expense: #ff6b6b; --bg: #f7f9fc; }
        body { font-family: "Varela Round", sans-serif; background: var(--bg); margin: 0; padding: 20px; }

        /* é‡‘é¡é¡¯ç¤ºå€ */
        .display-area {
            background: #fff; padding: 20px; border-radius: 20px; text-align: right;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        .amount-input { font-size: 3rem; border: none; width: 100%; text-align: right; outline: none; color: #333; }
        
        /* é¡å‹åˆ‡æ› (æ”¶å…¥/æ”¯å‡º) */
        .type-toggle { display: flex; background: #eee; border-radius: 50px; padding: 5px; margin-bottom: 20px; }
        .type-btn { flex: 1; padding: 10px; border-radius: 40px; text-align: center; cursor: pointer; transition: 0.3s; color: #888; }
        .type-btn.active.expense { background: var(--expense); color: white; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4); }
        .type-btn.active.income { background: var(--income); color: white; box-shadow: 0 4px 10px rgba(29, 209, 161, 0.4); }

        /* å¸³æˆ¶é¸æ“‡ */
        .account-selector { margin-bottom: 20px; }
        select { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #eee; background: white; font-size: 1rem; }

        /* é¡åˆ¥åœ–ç¤ºç¶²æ ¼ */
        .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .cat-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: white; border-radius: 15px; padding: 15px 5px; cursor: pointer; transition: 0.2s;
            border: 2px solid transparent;
        }
        .cat-item.selected { border-color: var(--primary); background: #eaf4ff; }
        .cat-icon { font-size: 1.5rem; margin-bottom: 5px; color: #555; }
        .cat-name { font-size: 0.8rem; color: #888; }

        /* ç¢ºèªæŒ‰éˆ• */
        .btn-submit {
            width: 100%; padding: 18px; background: var(--primary); color: white; 
            border: none; border-radius: 15px; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 5px 15px rgba(84, 160, 255, 0.4); cursor: pointer;
        }
        .btn-submit:active { transform: scale(0.98); }

        /* å‚™è¨»æ¬„ */
        .note-input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 15px; margin-bottom: 20px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="type-toggle">
        <div class="type-btn active expense" onclick="setType('expense')">æ”¯å‡º ğŸ’¸</div>
        <div class="type-btn income" onclick="setType('income')">æ”¶å…¥ ğŸ’°</div>
    </div>

    <div class="display-area">
        <input type="number" id="amount" class="amount-input" placeholder="0" inputmode="numeric">
    </div>

    <div class="account-selector">
        <select id="accountSelect">
            <option>è¼‰å…¥å¸³æˆ¶ä¸­...</option>
        </select>
    </div>

    <div class="category-grid" id="catGrid">
        </div>

    <input type="text" id="note" class="note-input" placeholder="å¯«é»å‚™è¨»å§... (é¸å¡«)">

    <button class="btn-submit" onclick="submitTrans()">è¨˜ä¸€ç­† âœ¨</button>

    <div style="text-align:center; margin-top:20px; color:#aaa; cursor:pointer;" onclick="location.href='index.html'">
        è¿”å›éŒ¢åŒ…
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz05y92IN__Za2ESzh5awOsNmmjCoe5K1uDU4RS59Oc20nso-ikqSW-NihFOFJ55_H1oA/exec'; // âš ï¸ åŒæ¨£è¦æ›æˆæ–°çš„
        const LIFF_ID = '2009160981-CWCxMTaI'; // å»ºè­°å¯ä»¥å…±ç”¨åŒä¸€å€‹ LIFF ID

        let currentType = 'expense';
        let selectedCategory = 'food';
        let currentUserId = null;

        const categories = {
            expense: [
                {id: 'food', name: 'é£²é£Ÿ', icon: 'fa-utensils'},
                {id: 'traffic', name: 'äº¤é€š', icon: 'fa-bus'},
                {id: 'shopping', name: 'è³¼ç‰©', icon: 'fa-shopping-bag'},
                {id: 'ent', name: 'å¨›æ¨‚', icon: 'fa-gamepad'},
                {id: 'life', name: 'ç”Ÿæ´»', icon: 'fa-home'},
                {id: 'other', name: 'å…¶ä»–', icon: 'fa-ellipsis-h'}
            ],
            income: [
                {id: 'salary', name: 'è–ªæ°´', icon: 'fa-briefcase'},
                {id: 'bonus', name: 'çé‡‘', icon: 'fa-gift'},
                {id: 'invest', name: 'æŠ•è³‡', icon: 'fa-chart-line'}
            ]
        };

        window.onload = async () => {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) liff.login();
            else {
                currentUserId = (await liff.getProfile()).userId;
                loadAccounts();
                renderCategories();
            }
        };

        function setType(type) {
            currentType = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.type-btn.${type}`).classList.add('active');
            renderCategories();
        }

        function renderCategories() {
            const grid = document.getElementById('catGrid');
            grid.innerHTML = '';
            categories[currentType].forEach((c, idx) => {
                const item = document.createElement('div');
                item.className = `cat-item ${idx === 0 ? 'selected' : ''}`; // é è¨­é¸ç¬¬ä¸€å€‹
                if(idx===0) selectedCategory = c.id;
                
                item.innerHTML = `<i class="fas ${c.icon} cat-icon"></i><div class="cat-name">${c.name}</div>`;
                item.onclick = () => {
                    document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    selectedCategory = c.id;
                };
                grid.appendChild(item);
            });
        }

        function loadAccounts() {
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'get_accounts', userId: currentUserId }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            })
            .then(res => res.json())
            .then(res => {
                const sel = document.getElementById('accountSelect');
                sel.innerHTML = '';
                res.data.forEach(acc => {
                    sel.innerHTML += `<option value="${acc.id}" data-type="${acc.type}">${acc.name} (é¤˜é¡/å‰©é¤˜: $${acc.balance})</option>`;
                });
            });
        }

        function submitTrans() {
            const amount = document.getElementById('amount').value;
            if(!amount) { alert('è«‹è¼¸å…¥é‡‘é¡ï¼'); return; }

            const accSelect = document.getElementById('accountSelect');
            const accountId = accSelect.value;
            const accountType = accSelect.options[accSelect.selectedIndex].getAttribute('data-type'); // credit_card or cash

            const btn = document.querySelector('.btn-submit');
            btn.innerText = "ç´€éŒ„ä¸­..."; btn.disabled = true;

            const data = {
                action: 'save_transaction',
                userId: currentUserId,
                type: currentType,
                amount: amount,
                category: selectedCategory,
                accountId: accountId,
                accountType: accountType,
                note: document.getElementById('note').value,
                date: new Date().toISOString()
            };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            })
            .then(res => res.json())
            .then(res => {
                alert('è¨˜å¸³æˆåŠŸï¼');
                location.href = 'index.html'; // è¨˜å®Œè·³å›éŒ¢åŒ…é 
            });
        }
    </script>
</body>
</html>
